name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy Backend and LiveKit Agent
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            set -e
            
            echo "ðŸš€ Starting deployment..."
            
            # ============================================
            # Deploy Backend
            # ============================================
            echo ""
            echo "ðŸ“¦ Deploying Backend..."
            cd /opt/aiagent
            
            # Clone or pull latest code
            if [ -d .git ]; then
              echo "Pulling latest code..."
              git pull origin main
            else
              echo "Initializing git repository and pulling code..."
              if [ ! -d backend ]; then
                mkdir -p backend
              fi
              # Clone to temp location and copy files
              git clone --depth 1 https://github.com/${{ github.repository }}.git /tmp/aiagent-temp
              rsync -av --exclude='.git' --exclude='venv' --exclude='__pycache__' /tmp/aiagent-temp/backend/ backend/
              rm -rf /tmp/aiagent-temp
            fi
            
            cd backend
            
            # Update Google OAuth credentials in .env if provided
            if [ -n "${{ secrets.GOOGLE_CLIENT_ID }}" ]; then
              echo "Updating GOOGLE_CLIENT_ID in .env..."
              if grep -q "GOOGLE_CLIENT_ID=" .env; then
                sed -i "s|GOOGLE_CLIENT_ID=.*|GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}|" .env
              else
                echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env
              fi
            fi
            
            if [ -n "${{ secrets.GOOGLE_CLIENT_SECRET }}" ]; then
              echo "Updating GOOGLE_CLIENT_SECRET in .env..."
              if grep -q "GOOGLE_CLIENT_SECRET=" .env; then
                sed -i "s|GOOGLE_CLIENT_SECRET=.*|GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}|" .env
              else
                echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> .env
              fi
            fi
            
            # Update virtual environment
            echo "Updating dependencies..."
            if [ ! -d venv ]; then
              python3 -m venv venv
            fi
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            
            # Update systemd service file to use correct command and load .env
            echo "Updating systemd service configuration..."
            printf '%s\n' \
              '[Unit]' \
              'Description=AI Receptionist FastAPI Backend' \
              'After=network.target' \
              '' \
              '[Service]' \
              'Type=simple' \
              'User=root' \
              'WorkingDirectory=/opt/aiagent' \
              'Environment="PATH=/opt/aiagent/backend/venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"' \
              'Environment="PYTHONPATH=/opt/aiagent"' \
              'EnvironmentFile=/opt/aiagent/backend/.env' \
              'ExecStart=/opt/aiagent/backend/venv/bin/python -m uvicorn backend.main:app --host 0.0.0.0 --port 8000' \
              'Restart=always' \
              'RestartSec=10' \
              '' \
              '[Install]' \
              'WantedBy=multi-user.target' > /etc/systemd/system/aiagent-backend.service
            systemctl daemon-reload
            
            # Restart backend service
            echo "Restarting backend service..."
            systemctl restart aiagent-backend
            sleep 5
            systemctl status aiagent-backend --no-pager | head -5
            
            # ============================================
            # Deploy LiveKit-Gemini Agent
            # ============================================
            echo ""
            echo "ðŸ“¦ Deploying LiveKit-Gemini Agent..."
            cd /opt/livekit-gemini
            
            # Clone or pull latest code
            if [ -d .git ]; then
              echo "Pulling latest code..."
              git pull origin main
            else
              echo "Copying latest agent files..."
              # Clone to temp location and copy files
              git clone --depth 1 https://github.com/${{ github.repository }}.git /tmp/aiagent-temp
              rsync -av --exclude='.git' --exclude='.env' /tmp/aiagent-temp/livekit-gemini/ /opt/livekit-gemini/
              rm -rf /tmp/aiagent-temp
            fi
            
            # Ensure .env exists and has required values
            if [ ! -f .env ]; then
              echo "Creating .env file..."
              cp .env.example .env 2>/dev/null || touch .env
            fi
            
            # Update .env with Google API key if provided
            if [ -n "${{ secrets.GOOGLE_API_KEY }}" ]; then
              echo "Updating GOOGLE_API_KEY in .env..."
              if grep -q "GOOGLE_API_KEY=" .env; then
                sed -i "s|GOOGLE_API_KEY=.*|GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}|" .env
              else
                echo "GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}" >> .env
              fi
              
              # Remove GEMINI_API_KEY to avoid confusion
              echo "Removing GEMINI_API_KEY from .env to use GOOGLE_API_KEY..."
              sed -i '/^GEMINI_API_KEY=/d' .env
            fi
            
            # Update BACKEND_URL if needed
            if grep -q "BACKEND_URL=" .env; then
              sed -i "s|BACKEND_URL=.*|BACKEND_URL=http://127.0.0.1:8000|" .env
            else
              echo "BACKEND_URL=http://127.0.0.1:8000" >> .env
            fi
            
            # Update livekit.yaml with API keys from .env
            echo "Updating livekit.yaml with API keys..."
            if [ -f .env ] && [ -f livekit.yaml ]; then
              API_KEY=$(grep "^LIVEKIT_API_KEY=" .env | cut -d'=' -f2)
              API_SECRET=$(grep "^LIVEKIT_API_SECRET=" .env | cut -d'=' -f2)
              if [ -n "$API_KEY" ] && [ -n "$API_SECRET" ]; then
                # Replace placeholder or existing keys in livekit.yaml
                if grep -q "YOUR_API_KEY_HERE" livekit.yaml; then
                  sed -i "s/YOUR_API_KEY_HERE: YOUR_API_SECRET_HERE/$API_KEY: $API_SECRET/" livekit.yaml
                else
                  # Update existing keys - replace the line after "keys:" with the new key:secret
                  sed -i "/^keys:/,/^[^ ]/ { /^  /s/.*/  $API_KEY: $API_SECRET/; }" livekit.yaml
                fi
                echo "Updated livekit.yaml with API keys"
              fi
            fi
            
            # Update sip.yaml with API keys from .env
            # Note: sip.yaml template in git has placeholders, we update it on server only
            echo "Updating sip.yaml with API keys from .env..."
            if [ -f .env ] && [ -f sip.yaml ]; then
              API_KEY=$(grep "^LIVEKIT_API_KEY=" .env | cut -d'=' -f2)
              API_SECRET=$(grep "^LIVEKIT_API_SECRET=" .env | cut -d'=' -f2)
              if [ -n "$API_KEY" ] && [ -n "$API_SECRET" ]; then
                sed -i "s|api_key: YOUR_API_KEY_HERE|api_key: $API_KEY|g" sip.yaml
                sed -i "s|api_secret: YOUR_API_SECRET_HERE|api_secret: $API_SECRET|g" sip.yaml
                sed -i "s|nat_external_ip: YOUR_VPS_IP_HERE|nat_external_ip: 185.8.130.155|g" sip.yaml
                echo "Updated sip.yaml with API keys"
              fi
            fi
            
            # Restart LiveKit server to pick up new keys
            echo "Restarting LiveKit server to apply configuration..."
            docker-compose restart livekit || true
            
            # Rebuild and restart containers
            echo "Rebuilding and restarting containers..."
            docker-compose down
            docker-compose build --no-cache agent
            docker-compose up -d
            
            echo ""
            echo "Waiting for services to start..."
            sleep 20
            
            # Recreate SIP trunk and dispatch rules (they're lost when containers restart)
            echo "Recreating SIP trunk and dispatch rules..."
            source .env
            
            # Install LiveKit CLI if not present
            if ! command -v lk &> /dev/null; then
              echo "Installing LiveKit CLI..."
              curl -sSL https://get.livekit.io/cli | bash
            fi
            
            # Create SIP trunk
            cat > /tmp/inbound-trunk.json << 'EOFTRUNK'
            {
              "trunk": {
                "name": "bulutfon",
                "numbers": ["+903322379153"],
                "allowed_addresses": ["trgw01.bulutfon.net"]
              }
            }
            EOFTRUNK
            
            LIVEKIT_URL=http://127.0.0.1:7880 \
            LIVEKIT_API_KEY=$LIVEKIT_API_KEY \
            LIVEKIT_API_SECRET=$LIVEKIT_API_SECRET \
            lk sip inbound create /tmp/inbound-trunk.json || echo "Trunk may already exist"
            
            # Create dispatch rule
            cat > /tmp/dispatch-rule.json << 'EOFDISPATCH'
            {
              "dispatch_rule": {
                "rule": {
                  "dispatch_rule_individual": {
                    "room_prefix": "sip-call-"
                  }
                },
                "name": "phone-number-routing",
                "room_config": {
                  "agents": [
                    {
                      "agent_name": "ai-receptionist"
                    }
                  ]
                }
              }
            }
            EOFDISPATCH
            
            # Delete old dispatch rule if it exists
            LIVEKIT_URL=http://127.0.0.1:7880 \
            LIVEKIT_API_KEY=$LIVEKIT_API_KEY \
            LIVEKIT_API_SECRET=$LIVEKIT_API_SECRET \
            lk sip dispatch delete phone-number-routing 2>/dev/null || echo "No existing dispatch rule to delete"
            
            # Create new dispatch rule
            LIVEKIT_URL=http://127.0.0.1:7880 \
            LIVEKIT_API_KEY=$LIVEKIT_API_KEY \
            LIVEKIT_API_SECRET=$LIVEKIT_API_SECRET \
            lk sip dispatch create /tmp/dispatch-rule.json || echo "Dispatch rule may already exist"
            
            echo "SIP configuration recreated successfully"
            
            # Check status
            echo ""
            echo "âœ… Deployment complete!"
            echo ""
            echo "=== Service Status ==="
            echo "Backend:"
            systemctl status aiagent-backend --no-pager | head -3
            echo ""
            echo "LiveKit Containers:"
            docker-compose ps
            echo ""
            echo "=== Health Checks ==="
            curl -s http://localhost:8000/health || echo "Backend health check failed"
            echo ""

