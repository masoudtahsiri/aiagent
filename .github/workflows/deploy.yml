name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy Backend and LiveKit Agent
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            set -e
            
            echo "ðŸš€ Starting deployment..."
            
            # ============================================
            # Deploy Backend
            # ============================================
            echo ""
            echo "ðŸ“¦ Deploying Backend..."
            cd /opt/aiagent
            
            # Clone or pull latest code
            if [ -d .git ]; then
              echo "Pulling latest code..."
              git pull origin main
            else
              echo "Initializing git repository and pulling code..."
              if [ ! -d backend ]; then
                mkdir -p backend
              fi
              # Clone to temp location and copy files
              git clone --depth 1 https://github.com/${{ github.repository }}.git /tmp/aiagent-temp
              rsync -av --exclude='.git' --exclude='venv' --exclude='__pycache__' /tmp/aiagent-temp/backend/ backend/
              rm -rf /tmp/aiagent-temp
            fi
            
            cd backend
            
            # Update virtual environment
            echo "Updating dependencies..."
            if [ ! -d venv ]; then
              python3 -m venv venv
            fi
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            
            # Update systemd service file to use correct command and load .env
            echo "Updating systemd service configuration..."
            cat > /etc/systemd/system/aiagent-backend.service << 'EOFSERVICE'
[Unit]
Description=AI Receptionist FastAPI Backend
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/aiagent
Environment="PATH=/opt/aiagent/backend/venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
Environment="PYTHONPATH=/opt/aiagent"
EnvironmentFile=/opt/aiagent/backend/.env
ExecStart=/opt/aiagent/backend/venv/bin/python -m uvicorn backend.main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOFSERVICE
            systemctl daemon-reload
            
            # Restart backend service
            echo "Restarting backend service..."
            systemctl restart aiagent-backend
            sleep 5
            systemctl status aiagent-backend --no-pager | head -5
            
            # ============================================
            # Deploy LiveKit-Gemini Agent
            # ============================================
            echo ""
            echo "ðŸ“¦ Deploying LiveKit-Gemini Agent..."
            cd /opt/livekit-gemini
            
            # Clone or pull latest code
            if [ -d .git ]; then
              echo "Pulling latest code..."
              git pull origin main
            else
              echo "Copying latest agent files..."
              # Clone to temp location and copy files
              git clone --depth 1 https://github.com/${{ github.repository }}.git /tmp/aiagent-temp
              rsync -av --exclude='.git' --exclude='.env' /tmp/aiagent-temp/livekit-gemini/ /opt/livekit-gemini/
              rm -rf /tmp/aiagent-temp
            fi
            
            # Ensure .env exists and has required values
            if [ ! -f .env ]; then
              echo "Creating .env file..."
              cp .env.example .env 2>/dev/null || touch .env
            fi
            
            # Update .env with Gemini API key if provided
            if [ -n "${{ secrets.GEMINI_API_KEY }}" ]; then
              echo "Updating GEMINI_API_KEY in .env..."
              if grep -q "GEMINI_API_KEY=" .env; then
                sed -i "s|GEMINI_API_KEY=.*|GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}|" .env
              else
                echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
              fi
            fi
            
            # Update BACKEND_URL if needed
            if grep -q "BACKEND_URL=" .env; then
              sed -i "s|BACKEND_URL=.*|BACKEND_URL=http://127.0.0.1:8000|" .env
            else
              echo "BACKEND_URL=http://127.0.0.1:8000" >> .env
            fi
            
            # Update livekit.yaml with API keys from .env
            echo "Updating livekit.yaml with API keys..."
            if [ -f .env ] && [ -f livekit.yaml ]; then
              API_KEY=$(grep "^LIVEKIT_API_KEY=" .env | cut -d'=' -f2)
              API_SECRET=$(grep "^LIVEKIT_API_SECRET=" .env | cut -d'=' -f2)
              if [ -n "$API_KEY" ] && [ -n "$API_SECRET" ]; then
                # Replace placeholder or existing keys in livekit.yaml
                if grep -q "YOUR_API_KEY_HERE" livekit.yaml; then
                  sed -i "s/YOUR_API_KEY_HERE: YOUR_API_SECRET_HERE/$API_KEY: $API_SECRET/" livekit.yaml
                else
                  # Update existing keys if they don't match
                  sed -i "s/^keys:.*/keys:\n  $API_KEY: $API_SECRET/" livekit.yaml
                fi
                echo "Updated livekit.yaml with API keys"
              fi
            fi
            
            # Rebuild and restart containers
            echo "Rebuilding and restarting containers..."
            docker-compose down
            docker-compose build --no-cache agent
            docker-compose up -d
            
            echo ""
            echo "Waiting for services to start..."
            sleep 10
            
            # Check status
            echo ""
            echo "âœ… Deployment complete!"
            echo ""
            echo "=== Service Status ==="
            echo "Backend:"
            systemctl status aiagent-backend --no-pager | head -3
            echo ""
            echo "LiveKit Containers:"
            docker-compose ps
            echo ""
            echo "=== Health Checks ==="
            curl -s http://localhost:8000/health || echo "Backend health check failed"
            echo ""

