{
  "name": "AI Agent - Complete Workflow",
  "nodes": [
    {
      "parameters": {
        "content": "## Google Calendar Multi-Staff Sync\n\n**Flow:**\n1. Webhook triggers sync\n2. Fetch ALL connected staff\n3. Loop through EACH staff member\n4. For each staff: get token + appointments\n5. Create/Update/Delete events on their calendar\n\n**Also handles:**\n- Rescheduled appointments (UPDATE)\n- Cancelled appointments (DELETE)\n- Google Push notifications (external events)",
        "height": 520,
        "width": 524,
        "color": 5
      },
      "id": "7652eebc-bc6e-4b2e-8339-435d57845350",
      "name": "Workflow Info",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        8240,
        -3136
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "calendar-sync",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "a35df2fc-ee0c-4781-96d5-ca513d638b9f",
      "name": "Database Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [
        8944,
        -2784
      ],
      "typeVersion": 2,
      "webhookId": "calendar-sync"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": true }",
        "options": {}
      },
      "id": "d5c9dd63-67a7-48de-b9f4-f00e15c018f6",
      "name": "Respond OK",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [
        9152,
        -2960
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "trigger-type",
              "name": "trigger_type",
              "value": "webhook",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "dcf5ac49-98d8-4bf6-b52c-e7915b32d8d5",
      "name": "Set Trigger Type",
      "type": "n8n-nodes-base.set",
      "position": [
        9152,
        -2624
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "url": "={{ $env.BACKEND_URL || 'http://localhost:8000' }}/api/calendar/sync-status",
        "options": {}
      },
      "id": "634ee32d-83d9-4a4b-82c6-ec18b18bdb6e",
      "name": "Get All Connected Staff",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        9328,
        -2784
      ],
      "typeVersion": 4.1
    },
    {
      "parameters": {
        "jsCode": "// Split staff list into individual items\n// n8n may split array responses, so use $input.all()\nconst items = $input.all();\nlet staffList = items.map(item => item.json);\n\n// If we got a wrapper object, extract the array\nif (staffList.length === 1 && staffList[0].data) {\n  staffList = staffList[0].data;\n}\n\nstaffList = staffList.filter(s => s && s.staff_id);\n\nif (staffList.length === 0) {\n  return [{ json: { no_staff: true } }];\n}\n\nconsole.log(`Found ${staffList.length} connected staff members`);\nreturn staffList.map(staff => ({ json: staff }));"
      },
      "id": "0ab858ec-91de-4e8f-8bd1-99468a04a6ec",
      "name": "Split Staff List",
      "type": "n8n-nodes-base.code",
      "position": [
        9536,
        -2784
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "has-staff",
              "leftValue": "={{ $json.no_staff }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "2afa45a3-6d3c-4af8-967f-8a0e9af1d3f9",
      "name": "Has Staff?",
      "type": "n8n-nodes-base.if",
      "position": [
        9712,
        -2784
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "url": "={{ $env.BACKEND_URL || 'http://localhost:8000' }}/api/calendar/sync-data",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "staff_id",
              "value": "={{ $('Loop Over Staff').item.json.staff_id }}"
            },
            {
              "name": "start_date",
              "value": "={{ $now.toISO().split('T')[0] }}"
            },
            {
              "name": "end_date",
              "value": "={{ $now.plus({days: 30}).toISO().split('T')[0] }}"
            }
          ]
        },
        "options": {}
      },
      "id": "3811b999-f532-467d-aeb3-e00743494203",
      "name": "Get Staff Appointments",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        10320,
        -2816
      ],
      "typeVersion": 4.1,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Merge token + appointments and filter those needing sync\nconst tokenData = $('Get Staff Token1').item.json;\nconst syncData = $input.first().json;\nconst staffInfo = $('Loop Over Staff').item.json;\n\nif (!tokenData || !tokenData.access_token) {\n  console.log(`No token for staff ${staffInfo.staff_id}`);\n  return [{ json: { skip: true, reason: 'no_token', staff_id: staffInfo.staff_id } }];\n}\n\nconst appointments = syncData.appointments || syncData.data || [];\n\n// Filter: needs sync = no google_event_id AND not cancelled\nconst needsSync = appointments.filter(apt => \n  !apt.google_event_id && \n  apt.status !== 'cancelled'\n);\n\nconsole.log(`Staff ${staffInfo.staff_id}: ${needsSync.length} of ${appointments.length} need syncing`);\n\nif (needsSync.length === 0) {\n  return [{ json: { skip: true, reason: 'no_appointments', staff_id: staffInfo.staff_id } }];\n}\n\nreturn [{\n  json: {\n    staff_id: staffInfo.staff_id,\n    calendar_id: tokenData.calendar_id || 'primary',\n    access_token: tokenData.access_token,\n    appointments: needsSync,\n    has_appointments: true\n  }\n}];"
      },
      "id": "66c183a7-051f-40ee-8b17-35b736c5ae8a",
      "name": "Merge Token + Appointments",
      "type": "n8n-nodes-base.code",
      "position": [
        10528,
        -2816
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "has-appointments",
              "leftValue": "={{ $json.has_appointments }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "612ceb18-3c4d-43ee-bc2f-143ca6f4c968",
      "name": "Has Appointments?",
      "type": "n8n-nodes-base.if",
      "position": [
        10720,
        -2816
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Split appointments into individual items for creating\nconst data = $input.first().json;\n\nif (!data.appointments || data.appointments.length === 0) {\n  return [{ json: { no_appointments: true } }];\n}\n\nfunction escapeForJson(str) {\n  if (!str) return '';\n  return str.replace(/\\\\/g, '\\\\\\\\').replace(/\"/g, '\\\\\"').replace(/\\n/g, '\\\\n').replace(/\\r/g, '\\\\r').replace(/\\t/g, '\\\\t');\n}\n\nreturn data.appointments.map(apt => {\n  const durationMinutes = apt.duration_minutes || apt.duration || 30;\n  \n  // Parse start time and calculate end time WITHOUT using Date object\n  const [hours, minutes, seconds] = apt.appointment_time.split(':').map(Number);\n  const totalMinutes = hours * 60 + minutes + durationMinutes;\n  const endHours = Math.floor(totalMinutes / 60) % 24;\n  const endMins = totalMinutes % 60;\n  const endTime = `${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}:00`;\n  \n  const startDateTime = `${apt.appointment_date}T${apt.appointment_time}`;\n  const endDateTime = `${apt.appointment_date}T${endTime}`;\n  \n  const customerName = apt.customers \n    ? `${apt.customers.first_name || ''} ${apt.customers.last_name || ''}`.trim() \n    : (apt.customer ? `${apt.customer.first_name || ''} ${apt.customer.last_name || ''}`.trim() : 'Customer');\n  const serviceName = apt.services?.name || apt.service?.name || 'Appointment';\n  const phone = apt.customers?.phone || apt.customer?.phone || 'N/A';\n  const notes = escapeForJson(apt.notes || '');\n  \n  return {\n    json: {\n      appointment_id: apt.id,\n      summary: `${serviceName}: ${customerName}`,\n      description: `appointment_id:${apt.id} | source:ai_receptionist | Service: ${serviceName} | Phone: ${phone} | Notes: ${notes}`,\n      start_datetime: startDateTime,\n      end_datetime: endDateTime,\n      duration_minutes: durationMinutes,\n      calendar_id: data.calendar_id,\n      access_token: data.access_token,\n      staff_id: data.staff_id\n    }\n  };\n});"
      },
      "id": "f320068e-d978-4fcb-bd7b-13bd8af374af",
      "name": "Process Appointments",
      "type": "n8n-nodes-base.code",
      "position": [
        10928,
        -2832
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "content": "## RESCHEDULED APPOINTMENTS\nUpdate existing Google Calendar events",
        "height": 80,
        "width": 400,
        "color": 4
      },
      "id": "eec0fcdf-e458-468a-954e-6102fba6d07e",
      "name": "Note - Rescheduled",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        11664,
        -2512
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "// Process rescheduled appointments\n// n8n splits array responses into separate items, so use $input.all()\nconst items = $input.all();\nlet appointments = items.map(item => item.json);\n\n// Filter: must have google_event_id to update\nappointments = appointments.filter(apt => apt && apt.id && apt.google_event_id && apt.staff_id);\n\nif (appointments.length === 0) {\n  return [{ json: { no_rescheduled: true } }];\n}\n\nconsole.log(`Found ${appointments.length} rescheduled appointments`);\nreturn appointments.map(apt => ({ json: apt }));"
      },
      "id": "97b80feb-250d-4aa4-a7c5-ed607f8ecafb",
      "name": "Process Rescheduled List",
      "type": "n8n-nodes-base.code",
      "position": [
        10320,
        -2496
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Get token AND prepare update data in one step\nconst apt = $input.first().json;\n\n// Fetch token via HTTP\nconst backendUrl = $env.BACKEND_URL || 'http://localhost:8000';\nconst tokenResponse = await this.helpers.httpRequest({\n  method: 'GET',\n  url: backendUrl + '/api/calendar/tokens/' + apt.staff_id,\n});\n\nif (!tokenResponse || !tokenResponse.access_token) {\n  return [{ json: { skip: true } }];\n}\n\nconst durationMinutes = apt.duration_minutes || apt.duration || 30;\n\nconst timeParts = apt.appointment_time.split(':');\nconst hours = parseInt(timeParts[0], 10);\nconst minutes = parseInt(timeParts[1], 10);\nconst totalMinutes = hours * 60 + minutes + durationMinutes;\nconst endHours = Math.floor(totalMinutes / 60) % 24;\nconst endMins = totalMinutes % 60;\nconst endTime = String(endHours).padStart(2, '0') + ':' + String(endMins).padStart(2, '0') + ':00';\n\nconst startDateTime = apt.appointment_date + 'T' + apt.appointment_time;\nconst endDateTime = apt.appointment_date + 'T' + endTime;\n\nconst customer = apt.customers || apt.customer || {};\nconst firstName = customer.first_name || '';\nconst lastName = customer.last_name || '';\nconst customerName = (firstName + ' ' + lastName).trim() || 'Customer';\nconst serviceName = (apt.services && apt.services.name) || (apt.service && apt.service.name) || 'Appointment';\nconst phone = customer.phone || 'N/A';\n\nreturn [{\n  json: {\n    appointment_id: apt.id,\n    google_event_id: apt.google_event_id,\n    summary: serviceName + ': ' + customerName,\n    description: 'appointment_id:' + apt.id + ' | source:ai_receptionist | Service: ' + serviceName + ' | Phone: ' + phone,\n    start_datetime: startDateTime,\n    end_datetime: endDateTime,\n    calendar_id: tokenResponse.calendar_id || 'primary',\n    access_token: tokenResponse.access_token,\n    skip: false\n  }\n}];"
      },
      "id": "af41c572-000a-4e4a-8ed9-11957216d8b1",
      "name": "Prepare Update Data",
      "type": "n8n-nodes-base.code",
      "position": [
        10720,
        -2512
      ],
      "typeVersion": 2,
      "alwaysOutputData": false,
      "executeOnce": false
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "not-skip",
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "e472e76c-4034-46f2-a6df-37771a36f4f5",
      "name": "Should Update?",
      "type": "n8n-nodes-base.if",
      "position": [
        10928,
        -2512
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "content": "## CANCELLED APPOINTMENTS\nDelete Google Calendar events",
        "height": 80,
        "width": 400,
        "color": 3
      },
      "id": "c019136c-58f4-42c2-894e-b41ac8c70535",
      "name": "Note - Cancelled",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        11664,
        -2240
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "// Process cancelled appointments\n// n8n splits array responses into separate items, so use $input.all()\nconst items = $input.all();\nlet appointments = items.map(item => item.json);\n\n// Filter: must have google_event_id to delete\nappointments = appointments.filter(apt => apt && apt.id && apt.google_event_id && apt.staff_id);\n\nif (appointments.length === 0) {\n  return [{ json: { no_cancelled: true } }];\n}\n\nconsole.log(`Found ${appointments.length} cancelled appointments to delete`);\nreturn appointments.map(apt => ({ json: apt }));"
      },
      "id": "b287ac9f-5dcd-43a2-a60b-9923de420427",
      "name": "Process Cancelled List",
      "type": "n8n-nodes-base.code",
      "position": [
        10320,
        -2208
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Get token AND prepare delete data in one step\nconst apt = $input.first().json;\n\n// Fetch token via HTTP\nconst backendUrl = $env.BACKEND_URL || 'http://localhost:8000';\nconst tokenResponse = await this.helpers.httpRequest({\n  method: 'GET',\n  url: backendUrl + '/api/calendar/tokens/' + apt.staff_id,\n});\n\nif (!tokenResponse || !tokenResponse.access_token) {\n  return [{ json: { skip: true } }];\n}\n\nreturn [{\n  json: {\n    appointment_id: apt.id,\n    google_event_id: apt.google_event_id,\n    calendar_id: tokenResponse.calendar_id || 'primary',\n    access_token: tokenResponse.access_token,\n    skip: false\n  }\n}];\n```\n\n**New flow:**\n```\nHas Cancelled? â†’ Prepare Delete Data (Code) â†’ Should Delete? â†’ Delete Google Event â†’ Mark as Deleted"
      },
      "id": "bb6f94f2-f9df-43c7-a25d-5529d998ecd8",
      "name": "Prepare Delete Data",
      "type": "n8n-nodes-base.code",
      "position": [
        10720,
        -2224
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "not-skip-del",
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "e48817cb-f1df-4059-ad60-38f6338fa327",
      "name": "Should Delete?",
      "type": "n8n-nodes-base.if",
      "position": [
        10928,
        -2224
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "content": "## GOOGLE PUSH NOTIFICATIONS\nReceive external calendar changes",
        "height": 80,
        "width": 400,
        "color": 7
      },
      "id": "5dda7475-ad6b-4c98-846d-d4446b46ccbf",
      "name": "Note - Push",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        11664,
        -3232
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "google-calendar-push",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "82121e96-310e-4137-b3fa-2fce6254ce75",
      "name": "Google Push Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [
        8944,
        -3216
      ],
      "typeVersion": 2,
      "webhookId": "google-calendar-push"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "OK",
        "options": {}
      },
      "id": "34e2dd99-7a9e-48dc-89fe-e3de9cf46a1e",
      "name": "Respond Push OK",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [
        9168,
        -3408
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "// Parse Google Push notification headers\nconst headers = $input.first().json.headers;\n\nconst channelId = headers['x-goog-channel-id'];\nconst resourceState = headers['x-goog-resource-state'];\nconst staffId = headers['x-goog-channel-token'];\nconst expiration = headers['x-goog-channel-expiration'];\n\n// Check if renewal needed\nlet needsRenewal = false;\nif (expiration) {\n  const expirationMs = new Date(expiration).getTime();\n  const hoursUntilExpiry = (expirationMs - Date.now()) / (1000 * 60 * 60);\n  needsRenewal = hoursUntilExpiry < 48;\n}\n\nconst isSyncMessage = resourceState === 'sync';\n\nif (isSyncMessage || !staffId) {\n  return [{ json: { skip: true, reason: isSyncMessage ? 'sync_message' : 'no_staff_id' } }];\n}\n\nreturn [{\n  json: {\n    channelId,\n    resourceState,\n    staff_id: staffId,\n    needsRenewal,\n    skip: false\n  }\n}];"
      },
      "id": "1aad6bfa-8328-42d1-967b-99904e1b343c",
      "name": "Parse Push Headers",
      "type": "n8n-nodes-base.code",
      "position": [
        9536,
        -3216
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "valid-push",
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "d8e95574-26ec-4717-b7ae-f4f5c43bbf53",
      "name": "Valid Push?",
      "type": "n8n-nodes-base.if",
      "position": [
        9712,
        -3216
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "needs-renewal",
              "leftValue": "={{ $json.needsRenewal }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "45f2290c-6b3e-4eb5-ba0f-8d81ae2ad61b",
      "name": "Needs Renewal?",
      "type": "n8n-nodes-base.if",
      "position": [
        9920,
        -3232
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL || 'http://localhost:8000' }}/api/calendar/webhooks/renew-watch",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "staff_id",
              "value": "={{ $('Valid Push?').item.json.staff_id }}"
            }
          ]
        },
        "options": {}
      },
      "id": "5045215b-dc0d-4187-b683-0aa606c70a2b",
      "name": "Renew Watch",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        10128,
        -3392
      ],
      "typeVersion": 4.1,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "={{ $env.BACKEND_URL || 'http://localhost:8000' }}/api/calendar/tokens/{{ $('Valid Push?').item.json.staff_id }}",
        "options": {}
      },
      "id": "1b7aceec-b1e2-4e0e-a525-6e4d0f057187",
      "name": "Get Push Token",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        10320,
        -3216
      ],
      "typeVersion": 4.1,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "={{ $env.BACKEND_URL || 'http://localhost:8000' }}/api/calendar/tokens/{{ $json.staff_id }}",
        "options": {}
      },
      "id": "42dcc32c-ecd6-498b-a7b3-4fcc96b6c8a5",
      "name": "Get Staff Token1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        10128,
        -2816
      ],
      "typeVersion": 4.1,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://www.googleapis.com/calendar/v3/calendars/{{ $json.calendar_id }}/events",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.access_token }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"summary\": \"{{ $json.summary }}\",\n  \"description\": \"{{ $json.description }}\",\n  \"start\": {\n    \"dateTime\": \"{{ $json.start_datetime }}\",\n    \"timeZone\": \"Europe/Istanbul\"\n  },\n  \"end\": {\n    \"dateTime\": \"{{ $json.end_datetime }}\",\n    \"timeZone\": \"Europe/Istanbul\"\n  },\n  \"extendedProperties\": {\n    \"private\": {\n      \"source\": \"ai_receptionist\",\n      \"appointment_id\": \"{{ $json.appointment_id }}\"\n    }\n  }\n}",
        "options": {
          "timeout": 15000
        }
      },
      "id": "a4f70254-845b-456b-88dc-9fced0f0bd0c",
      "name": "Create Google Event1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        11136,
        -2832
      ],
      "typeVersion": 4.1,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL || 'http://localhost:8000' }}/api/calendar/mark-appointment-synced",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"appointment_id\": \"{{ $('Process Appointments').item.json.appointment_id }}\",\n  \"google_event_id\": \"{{ $json.id }}\"\n}",
        "options": {}
      },
      "id": "fdcd8b95-a441-4715-9c20-9e3775141777",
      "name": "Mark as Synced1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        11344,
        -2832
      ],
      "typeVersion": 4.1,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "={{ $env.BACKEND_URL || 'http://localhost:8000' }}/api/calendar/rescheduled-appointments",
        "options": {}
      },
      "id": "938cf86c-0395-47e3-8860-69c6ab5e0451",
      "name": "Get Rescheduled1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        10128,
        -2496
      ],
      "typeVersion": 4.1,
      "alwaysOutputData": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "has-rescheduled",
              "leftValue": "={{ $json.no_rescheduled }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "bb8e4401-b99b-447a-8b41-4b3f7153a0f2",
      "name": "Has Rescheduled?1",
      "type": "n8n-nodes-base.if",
      "position": [
        10528,
        -2496
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://www.googleapis.com/calendar/v3/calendars/{{ $json.calendar_id }}/events/{{ $json.google_event_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.access_token }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"summary\": \"{{ $json.summary }}\",\n  \"description\": \"{{ $json.description }}\",\n  \"start\": {\n    \"dateTime\": \"{{ $json.start_datetime }}\",\n    \"timeZone\": \"Europe/Istanbul\"\n  },\n  \"end\": {\n    \"dateTime\": \"{{ $json.end_datetime }}\",\n    \"timeZone\": \"Europe/Istanbul\"\n  },\n  \"extendedProperties\": {\n    \"private\": {\n      \"source\": \"ai_receptionist\",\n      \"appointment_id\": \"{{ $('Should Update?').item.json.appointment_id }}\"\n    }\n  }\n}",
        "options": {
          "timeout": 15000
        }
      },
      "id": "517e9c60-ce83-466e-bf57-68260543147b",
      "name": "Update Google Event1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        11136,
        -2528
      ],
      "typeVersion": 4.1,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL || 'http://localhost:8000' }}/api/calendar/mark-appointment-updated",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"appointment_id\": \"{{ $('Should Update?').item.json.appointment_id }}\"\n}",
        "options": {}
      },
      "id": "c1029a76-71e5-453d-95ec-20c68de81f76",
      "name": "Mark as Updated1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        11344,
        -2528
      ],
      "typeVersion": 4.1,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "={{ $env.BACKEND_URL || 'http://localhost:8000' }}/api/calendar/cancelled-appointments",
        "options": {}
      },
      "id": "381c421c-ff60-4f1e-8138-a332c512e1f0",
      "name": "Get Cancelled1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        10128,
        -2208
      ],
      "typeVersion": 4.1,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "has-cancelled",
              "leftValue": "={{ $json.no_cancelled }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "dd5df74f-6aab-44cf-825a-dd9741164a61",
      "name": "Has Cancelled?1",
      "type": "n8n-nodes-base.if",
      "position": [
        10528,
        -2208
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=https://www.googleapis.com/calendar/v3/calendars/{{ $json.calendar_id }}/events/{{ $json.google_event_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.access_token }}"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "76e7bbbb-192a-4dba-b431-98cac93c2170",
      "name": "Delete Google Event1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        11136,
        -2240
      ],
      "typeVersion": 4.1,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL || 'http://localhost:8000' }}/api/calendar/mark-appointment-deleted",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"appointment_id\": \"{{ $('Should Delete?').item.json.appointment_id }}\"\n}",
        "options": {}
      },
      "id": "db23b0f2-326d-426e-a753-c3ab4de1bc62",
      "name": "Mark as Deleted1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        11344,
        -2240
      ],
      "typeVersion": 4.1,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "=https://www.googleapis.com/calendar/v3/calendars/{{ $json.calendar_id || 'primary' }}/events",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "timeMin",
              "value": "={{ $now.toISO() }}"
            },
            {
              "name": "timeMax",
              "value": "={{ $now.plus({days: 30}).toISO() }}"
            },
            {
              "name": "singleEvents",
              "value": "true"
            },
            {
              "name": "orderBy",
              "value": "startTime"
            },
            {
              "name": "maxResults",
              "value": "100"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.access_token }}"
            }
          ]
        },
        "options": {}
      },
      "id": "4c439da4-d08e-461c-a2a1-b2478d0f83d9",
      "name": "Get Google Events1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        10528,
        -3216
      ],
      "typeVersion": 4.1,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Process Google Calendar events\nconst input = $input.first().json;\nconst items = input.items || [];\nconst staffId = $('Valid Push?').first().json.staff_id;\n\nconst externalEvents = [];\nconst allEventIds = [];\n\nfor (const event of items) {\n  if (!event.id) continue;\n  \n  allEventIds.push(event.id);\n  \n  // Check if this is OUR event\n  const description = event.description || '';\n  const isOurEvent = description.includes('appointment_id:') || \n                     description.includes('source:ai_receptionist') ||\n                     (event.extendedProperties?.private?.source === 'ai_receptionist');\n  \n  if (isOurEvent || event.status === 'cancelled') continue;\n  \n  let startTime, endTime, isAllDay;\n  \n  if (event.start?.dateTime) {\n    startTime = event.start.dateTime;\n    endTime = event.end?.dateTime || event.start.dateTime;\n    isAllDay = false;\n  } else if (event.start?.date) {\n    startTime = event.start.date;\n    endTime = event.end?.date || event.start.date;\n    isAllDay = true;\n  } else continue;\n  \n  externalEvents.push({\n    staff_id: staffId,\n    google_event_id: event.id,\n    summary: event.summary || 'Busy',\n    start: startTime,\n    end: endTime,\n    is_all_day: isAllDay\n  });\n}\n\nreturn [{\n  json: {\n    staff_id: staffId,\n    external_events: externalEvents,\n    all_event_ids: allEventIds,\n    has_external_events: externalEvents.length > 0\n  }\n}];"
      },
      "id": "b72eb398-3bd3-42a2-ae00-811f3c50d79f",
      "name": "Process Google Events1",
      "type": "n8n-nodes-base.code",
      "position": [
        10720,
        -3216
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL || 'http://localhost:8000' }}/api/calendar/watch/cleanup-deleted-events",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"staff_id\": \"{{ $json.staff_id }}\",\n  \"current_event_ids\": {{ JSON.stringify($json.all_event_ids) }}\n}",
        "options": {}
      },
      "id": "7b6514a8-a14b-4200-bf44-a771b5d2c79b",
      "name": "Cleanup Deleted Events1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        10928,
        -3424
      ],
      "typeVersion": 4.1,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "has-external",
              "leftValue": "={{ $json.has_external_events }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "3fc261d0-f906-423a-850f-02c4629f20f1",
      "name": "Has External Events?1",
      "type": "n8n-nodes-base.if",
      "position": [
        10928,
        -3216
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nreturn data.external_events.map(event => ({ json: event }));"
      },
      "id": "66bdc936-28f2-457d-beca-23c78544e12a",
      "name": "Split External Events1",
      "type": "n8n-nodes-base.code",
      "position": [
        11136,
        -3232
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL || 'http://localhost:8000' }}/api/calendar/block-from-calendar",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"staff_id\": \"{{ $json.staff_id }}\",\n  \"google_event_id\": \"{{ $json.google_event_id }}\",\n  \"start\": \"{{ $json.start }}\",\n  \"end\": \"{{ $json.end }}\",\n  \"summary\": \"{{ $json.summary }}\",\n  \"is_all_day\": {{ $json.is_all_day }}\n}",
        "options": {}
      },
      "id": "c89fadfc-21e1-4dc7-9c4d-c2bacb8134db",
      "name": "Block Time Slots1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        11344,
        -3232
      ],
      "typeVersion": 4.1,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "## CREATE APPOINTMENTS\ncreate Google Calendar events",
        "height": 80,
        "width": 384
      },
      "id": "4dce0c39-2d89-458b-b9b8-23b66016f415",
      "name": "Note - Rescheduled1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        11664,
        -2832
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "// Loop through staff items and output each one\n// Prevent infinite loops by detecting loop-backs\nconst items = $input.all();\n\nif (items.length === 0) {\n  return [{ json: { no_staff: true } }];\n}\n\n// Detect if this is a loop-back from processing (not initial input from Has Staff?)\n// Loop-backs will have different data structure:\n// - From Mark as Synced1: has appointment_id or success response\n// - From Has Appointments? (FALSE): has skip flag or no staff_id\n// - From initial: has staff_id, calendar_id, etc. (staff connection data)\nconst firstItem = items[0].json;\nconst isLoopBack = !firstItem.staff_id || \n                   firstItem.skip === true || \n                   firstItem.appointment_id || \n                   firstItem.success !== undefined ||\n                   firstItem.id !== undefined; // Google event ID or appointment ID\n\n// If this is a loop-back, stop the loop by returning empty\nif (isLoopBack) {\n  console.log('Loop-back detected, stopping to prevent infinite loop');\n  return [];\n}\n\n// This is initial input from Has Staff? - output all staff items\nconst staffItems = items.filter(item => item.json && item.json.staff_id && item.json.calendar_id);\n\nif (staffItems.length === 0) {\n  return [{ json: { no_staff: true } }];\n}\n\nconsole.log(`Processing ${staffItems.length} staff member(s)`);\n\n// Output each staff item individually\nreturn staffItems.map(item => ({ json: item.json }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9920,
        -2800
      ],
      "id": "1dc97492-e76a-4f2b-8e06-e2a179b42af0",
      "name": "Loop Over Staff"
    },
    {
      "parameters": {
        "content": "## â° APPOINTMENT REMINDERS\n\nAutomatically sends:\n- 24-hour SMS + AI call reminder\n- 1-hour SMS + AI call reminder\n\nRuns every hour to check upcoming appointments.",
        "height": 200,
        "width": 448,
        "color": 4
      },
      "id": "a0c0ec2e-e7ff-40ec-8125-81d4015ffad6",
      "name": "Note - Reminders",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        13040,
        -3232
      ],
      "typeVersion": 1,
      "disabled": true
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours"
            }
          ]
        }
      },
      "id": "b183f7a6-03ef-4019-a2bf-bf25b2d2cb42",
      "name": "Every Hour (Reminders)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [
        13584,
        -3184
      ],
      "typeVersion": 1.1,
      "disabled": true
    },
    {
      "parameters": {
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/appointments?select=*,customers(id,first_name,last_name,phone,email,language),businesses(id,business_name),services(name),staff(name)&status=eq.scheduled&appointment_date=gte.{{ $now.format('yyyy-MM-dd') }}&appointment_date=lte.{{ $now.plus({ days: 1 }).format('yyyy-MM-dd') }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "29ba98be-da90-44bb-816a-d1120c0a8068",
      "name": "Get Upcoming Appointments (Reminders)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        13808,
        -3184
      ],
      "typeVersion": 4.1,
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "const now = new Date();\nconst appointments = $input.all();\nconst remindersNeeded = [];\n\nfor (const item of appointments) {\n  const apt = item.json;\n  const aptDate = new Date(`${apt.appointment_date}T${apt.appointment_time}`);\n  const hoursUntil = (aptDate - now) / (1000 * 60 * 60);\n  \n  if (!apt.customers?.phone) continue;\n  \n  if (hoursUntil >= 23 && hoursUntil <= 25) {\n    remindersNeeded.push({...apt, reminder_type: 'reminder_24h', hours_until: Math.round(hoursUntil)});\n  } else if (hoursUntil >= 0.5 && hoursUntil <= 1.5) {\n    remindersNeeded.push({...apt, reminder_type: 'reminder_1h', hours_until: Math.round(hoursUntil * 10) / 10});\n  }\n}\n\nreturn remindersNeeded.map(r => ({ json: r }));"
      },
      "id": "0971ef3a-e3eb-40b6-b08e-7181f108a815",
      "name": "Filter Needing Reminders",
      "type": "n8n-nodes-base.code",
      "position": [
        14016,
        -3184
      ],
      "typeVersion": 2,
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-items",
              "leftValue": "={{ $input.all().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ef28bc2d-dfc4-489b-a005-cfc8e3a0eabe",
      "name": "Has Reminders?",
      "type": "n8n-nodes-base.if",
      "position": [
        14224,
        -3184
      ],
      "typeVersion": 2,
      "disabled": true
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "3c331ae0-7740-40c1-af8d-003df2099346",
      "name": "Process Each Reminder",
      "type": "n8n-nodes-base.splitInBatches",
      "position": [
        14432,
        -3184
      ],
      "typeVersion": 3,
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL }}/api/outbound/schedule",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"business_id\": \"{{ $json.business_id }}\",\n  \"customer_id\": \"{{ $json.customers.id }}\",\n  \"phone_number\": \"{{ $json.customers.phone }}\",\n  \"call_type\": \"{{ $json.reminder_type === 'reminder_24h' ? 'appointment_reminder' : 'appointment_reminder_1h' }}\",\n  \"scheduled_for\": \"{{ $now.toISO() }}\",\n  \"priority\": {{ $json.reminder_type === 'reminder_1h' ? 8 : 6 }},\n  \"script_type\": \"appointment_reminder\",\n  \"context_data\": {\n    \"appointment_id\": \"{{ $json.id }}\",\n    \"appointment_date\": \"{{ $json.appointment_date }}\",\n    \"appointment_time\": \"{{ $json.appointment_time }}\",\n    \"service_name\": \"{{ $json.services?.name || '' }}\",\n    \"customer_name\": \"{{ $json.customers.first_name }}\",\n    \"hours_until\": {{ $json.hours_until }}\n  }\n}",
        "options": {}
      },
      "id": "98ae9840-2f07-43e6-a188-c6471c2f5916",
      "name": "Schedule Reminder Call",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        14992,
        -3088
      ],
      "typeVersion": 4.1,
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL }}/api/messaging/send-sms",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"business_id\": \"{{ $json.business_id }}\",\n  \"customer_id\": \"{{ $json.customers.id }}\",\n  \"to_phone\": \"{{ $json.customers.phone }}\",\n  \"message\": \"{{ $json.reminder_type === 'reminder_24h' ? 'Reminder: You have an appointment at ' + ($json.businesses?.business_name || 'our office') + ' tomorrow at ' + $json.appointment_time + '. Reply CONFIRM or call to reschedule.' : 'Your appointment at ' + ($json.businesses?.business_name || 'our office') + ' is in 1 hour at ' + $json.appointment_time + '. See you soon!' }}\"\n}",
        "options": {}
      },
      "id": "fde6b813-822c-4e18-8ee8-bfbe64469915",
      "name": "Send SMS Reminder",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        14992,
        -3408
      ],
      "typeVersion": 4.1,
      "disabled": true
    },
    {
      "parameters": {},
      "id": "d302453d-4f05-4f6a-a40e-2d152c65a786",
      "name": "No Reminders",
      "type": "n8n-nodes-base.noOp",
      "position": [
        14416,
        -2832
      ],
      "typeVersion": 1,
      "disabled": true
    },
    {
      "parameters": {
        "content": "## ðŸ“§ EMAIL SENDING\n\nWebhook endpoint for sending emails via SMTP.\nLogs all sent messages to database.\n\nWebhook: POST /send-email",
        "width": 400,
        "color": 2
      },
      "id": "b9084355-3e82-421b-9c98-166297ec5679",
      "name": "Note - Email",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        13024,
        -2368
      ],
      "typeVersion": 1,
      "disabled": true
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "send-email",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "53bbf099-4c68-409a-8f03-244bf88f3a5c",
      "name": "Send Email Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [
        13568,
        -2320
      ],
      "typeVersion": 1.1,
      "webhookId": "send-email-webhook",
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-to",
              "leftValue": "={{ $json.body.to_email }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "isNotEmpty"
              }
            },
            {
              "id": "has-subject",
              "leftValue": "={{ $json.body.subject }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "isNotEmpty"
              }
            },
            {
              "id": "has-body",
              "leftValue": "={{ $json.body.message }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "isNotEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "e85dcd3b-7bc3-42fd-a761-36b1dd2ee513",
      "name": "Validate Email Data",
      "type": "n8n-nodes-base.if",
      "position": [
        13808,
        -2320
      ],
      "typeVersion": 2,
      "disabled": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": false, \"error\": \"Missing required fields\" }",
        "options": {
          "responseCode": 400
        }
      },
      "id": "de63d7d7-52fe-4530-b0f7-c3400bd7c0dc",
      "name": "Respond Email Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [
        14016,
        -2160
      ],
      "typeVersion": 1,
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json.body;\nconst plainMessage = input.message;\nconst htmlMessage = plainMessage.split('\\n\\n').map(para => `<p>${para.replace(/\\n/g, '<br>')}</p>`).join('');\nconst businessName = input.business_name || 'Our Team';\nconst primaryColor = input.brand_color || '#4F46E5';\n\nconst htmlBody = `<!DOCTYPE html><html><head><meta charset=\"utf-8\"><style>body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;line-height:1.6;color:#333}.container{max-width:600px;margin:0 auto;padding:20px}.header{background:${primaryColor};color:white;padding:20px;text-align:center;border-radius:8px 8px 0 0}.content{background:#f9fafb;padding:30px;border:1px solid #e5e7eb}.footer{background:#f3f4f6;padding:20px;text-align:center;font-size:12px;color:#6b7280;border-radius:0 0 8px 8px}p{margin:0 0 16px}</style></head><body><div class=\"container\"><div class=\"header\"><h1 style=\"margin:0;font-size:24px\">${businessName}</h1></div><div class=\"content\">${htmlMessage}</div><div class=\"footer\"><p>This email was sent by ${businessName}</p></div></div></body></html>`;\n\nreturn [{\n  json: {\n    to: input.to_email,\n    subject: input.subject,\n    text: plainMessage,\n    html: htmlBody,\n    business_id: input.business_id,\n    customer_id: input.customer_id\n  }\n}];"
      },
      "id": "2da3aff2-4692-48f3-b894-cf63fbbd156b",
      "name": "Prepare Email Content",
      "type": "n8n-nodes-base.code",
      "position": [
        14016,
        -2432
      ],
      "typeVersion": 2,
      "disabled": true
    },
    {
      "parameters": {
        "fromEmail": "={{ $env.EMAIL_FROM || 'noreply@example.com' }}",
        "toEmail": "={{ $json.to }}",
        "subject": "={{ $json.subject }}",
        "emailFormat": "both",
        "text": "={{ $json.text }}",
        "html": "={{ $json.html }}",
        "options": {}
      },
      "id": "fb6c469a-c78b-4eb6-a266-0f3a13898aba",
      "name": "Send via SMTP",
      "type": "n8n-nodes-base.emailSend",
      "position": [
        14208,
        -2432
      ],
      "typeVersion": 2.1,
      "webhookId": "682c0d6a-3a9c-448a-9616-bf84f0abe82d",
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/message_log",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"business_id\": \"{{ $('Prepare Email Content').first().json.business_id }}\",\n  \"customer_id\": \"{{ $('Prepare Email Content').first().json.customer_id || null }}\",\n  \"channel\": \"email\",\n  \"direction\": \"outbound\",\n  \"to_address\": \"{{ $('Prepare Email Content').first().json.to }}\",\n  \"subject\": \"{{ $('Prepare Email Content').first().json.subject }}\",\n  \"body\": \"{{ $('Prepare Email Content').first().json.text }}\",\n  \"status\": \"sent\",\n  \"sent_at\": \"{{ $now.toISO() }}\"\n}",
        "options": {}
      },
      "id": "46dc6ee7-4d57-47b5-ac0d-1c057ec3c5ac",
      "name": "Log Email to Database",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        14416,
        -2432
      ],
      "typeVersion": 4.1,
      "disabled": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"to\": \"{{ $('Prepare Email Content').first().json.to }}\"\n}",
        "options": {}
      },
      "id": "9affc7d3-1b87-464d-9885-06b713411c33",
      "name": "Respond Email Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [
        14640,
        -2432
      ],
      "typeVersion": 1,
      "disabled": true
    },
    {
      "parameters": {
        "content": "## ðŸ§  POST-CALL MEMORY PROCESSING\n\n**Triggered by:** Supabase Database Webhook\nWhen call_logs.transcript is updated:\n1. Analyzes transcript with Gemini\n2. Extracts memories & preferences\n3. Saves to customer profile\n4. Updates call log with summary\n\nWebhook: POST /call-ended\n\n**Setup in Supabase:**\n1. Go to Database â†’ Webhooks\n2. Create webhook on call_logs UPDATE\n3. Filter: transcript IS NOT NULL\n4. URL: https://n8n.algorityai.com/webhook/call-ended",
        "height": 608,
        "width": 566,
        "color": 6
      },
      "id": "5df418d5-cad8-43ab-834a-64927eef2ce4",
      "name": "Note - Memory1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        8176,
        -4320
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        9632,
        -4080
      ],
      "id": "7fd1b0a2-864b-4ce4-8a8a-7e08b88a29dd",
      "name": "Gemini for Memory Analysis",
      "credentials": {
        "googlePalmApi": {
          "id": "oW5387vYLjnaOk4e",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse Supabase webhook payload\n// Supabase sends: { type, table, record, old_record, schema }\nconst input = $input.first().json;\n\n// Handle both direct call and Supabase webhook format\nlet callData;\n\nif (input.body?.record) {\n  // Supabase webhook format\n  callData = input.body.record;\n} else if (input.body?.transcript) {\n  // Direct webhook format (backwards compatible)\n  callData = input.body;\n} else if (input.record) {\n  // Supabase without body wrapper\n  callData = input.record;\n} else {\n  // Assume it's the call data directly\n  callData = input.body || input;\n}\n\n// Extract required fields\nconst transcript = callData.transcript;\nconst customer_id = callData.customer_id;\nconst business_id = callData.business_id;\nconst call_log_id = callData.id || callData.call_log_id;\n\n// Validate\nif (!transcript || transcript.length < 50) {\n  return [{ json: { skip: true, reason: 'transcript_too_short' } }];\n}\n\nif (!customer_id) {\n  return [{ json: { skip: true, reason: 'no_customer_id' } }];\n}\n\nreturn [{\n  json: {\n    call_log_id,\n    customer_id,\n    business_id,\n    transcript,\n    language: callData.language_code || 'en',\n    is_outbound: callData.is_outbound || false,\n    call_outcome: callData.outcome || 'general_inquiry',\n    valid: true\n  }\n}];"
      },
      "id": "74716576-6540-4a4c-81f9-ace382eaf1d9",
      "name": "Parse Webhook Data1",
      "type": "n8n-nodes-base.code",
      "position": [
        9152,
        -4080
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "is-valid",
              "leftValue": "={{ $json.valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "b68c14db-d8b6-4b47-8528-c4cbad8d252f",
      "name": "Has Valid Data?1",
      "type": "n8n-nodes-base.if",
      "position": [
        9376,
        -4080
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "call-ended",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "5ca851c1-adfc-42d6-95a9-59abafa36318",
      "name": "Call Ended Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [
        8928,
        -4080
      ],
      "typeVersion": 1.1,
      "webhookId": "call-ended-webhook"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": false, \"reason\": \"Missing or invalid data\" }",
        "options": {
          "responseCode": 400
        }
      },
      "id": "d72a644e-9062-4867-871f-38cdbe2c57ac",
      "name": "Respond Validation Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [
        9600,
        -3872
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "// LLM Chain returns { text: \"...\" } directly\nconst input = $input.first();\nconst geminiResponse = input.json;\nconst originalData = $('Parse Webhook Data1').first().json;\n\n// Get text from LLM Chain output (simpler format than raw API)\nlet analysisText = geminiResponse.text || geminiResponse.response || '';\n\nif (!analysisText) {\n  // Fallback: try raw API format in case HTTP request is used\n  try {\n    analysisText = geminiResponse.candidates[0].content.parts[0].text;\n  } catch (e) {\n    return [{ json: { error: 'Failed to extract response', originalData } }];\n  }\n}\n\nlet analysis;\ntry {\n  // Clean up markdown code blocks if present\n  analysisText = analysisText.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  analysis = JSON.parse(analysisText);\n} catch (e) {\n  return [{ json: { error: 'Failed to parse JSON', rawText: analysisText, originalData } }];\n}\n\nreturn [{\n  json: {\n    call_log_id: originalData.call_log_id,\n    customer_id: originalData.customer_id,\n    business_id: originalData.business_id,\n    analysis: analysis\n  }\n}];"
      },
      "id": "e7fe1046-a186-4979-81b0-109575d1f143",
      "name": "Parse Gemini Response",
      "type": "n8n-nodes-base.code",
      "position": [
        9808,
        -4176
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-analysis",
              "leftValue": "={{ $json.analysis }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "79e2ccc5-c00f-493d-8ccb-ce4c0c66492b",
      "name": "Analysis Valid?",
      "type": "n8n-nodes-base.if",
      "position": [
        10032,
        -4176
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst memories = input.analysis.memories || [];\nreturn memories.map(mem => ({\n  json: {\n    customer_id: input.customer_id,\n    business_id: input.business_id,\n    memory_type: mem.type || 'note',\n    content: mem.content,\n    importance: mem.importance || 5,\n    source_type: 'call',\n    source_id: input.call_log_id\n  }\n}));"
      },
      "id": "c555bd7e-09c9-4e60-a28a-952129694a7d",
      "name": "Prepare Memories",
      "type": "n8n-nodes-base.code",
      "position": [
        10256,
        -4272
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL || 'http://localhost:8000' }}/api/memory/save",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "86000e57-e2dc-447c-b2f5-0b54860550ed",
      "name": "Save Memories",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        10480,
        -4272
      ],
      "typeVersion": 4.1
    },
    {
      "parameters": {
        "jsCode": "const input = $('Analysis Valid?').first().json;\nconst preferences = input.analysis.preferences || [];\nreturn preferences.map(pref => ({\n  json: {\n    customer_id: input.customer_id,\n    business_id: input.business_id,\n    category: pref.category || 'general',\n    preference_key: pref.key,\n    preference_value: pref.value,\n    confidence: pref.confidence || 0.7\n  }\n}));"
      },
      "id": "cccf8f58-4a36-4040-96d7-1934e3fd3ca1",
      "name": "Prepare Preferences",
      "type": "n8n-nodes-base.code",
      "position": [
        10256,
        -4080
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL || 'http://localhost:8000' }}/api/memory/preference",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "9fde7a7d-e197-47b9-aa9c-fb788c0a43bd",
      "name": "Save Preferences",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        10480,
        -4080
      ],
      "typeVersion": 4.1,
      "credentials": {
        "httpHeaderAuth": {
          "id": "fjR9QfUq7nkiIOgD",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://cwcjsgdbrqjljekxpgxz.supabase.co/rest/v1/customers?id=eq.{{ $('Analysis Valid?').first().json.customer_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"last_call_summary\": \"{{ $('Analysis Valid?').first().json.analysis.call_summary || '' }}\",\n  \"last_call_at\": \"{{ $now.toISO() }}\"\n}",
        "options": {}
      },
      "id": "e538402a-46a1-4ca2-92ba-b8eba5d1dfbf",
      "name": "Update Customer Summary",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        10288,
        -4544
      ],
      "typeVersion": 4.1,
      "credentials": {
        "httpHeaderAuth": {
          "id": "fjR9QfUq7nkiIOgD",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": true, \"message\": \"Memory processing complete\" }",
        "options": {}
      },
      "id": "0655f271-e962-4048-b710-c9478e247b2e",
      "name": "Respond Memory Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [
        10688,
        -4080
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": false, \"reason\": \"Analysis failed or invalid data\" }",
        "options": {
          "responseCode": 400
        }
      },
      "id": "66810d85-f9d9-4646-a475-1f86688ba05b",
      "name": "Respond Analysis Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [
        10032,
        -3872
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "messages": {
          "messageValues": []
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        9520,
        -4288
      ],
      "id": "e67dd163-28fc-4667-b21f-92e83dc48968",
      "name": "Analyze with Gemini"
    }
  ],
  "pinData": {},
  "connections": {
    "Database Webhook": {
      "main": [
        [
          {
            "node": "Respond OK",
            "type": "main",
            "index": 0
          },
          {
            "node": "Set Trigger Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Trigger Type": {
      "main": [
        [
          {
            "node": "Get All Connected Staff",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Rescheduled1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Cancelled1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get All Connected Staff": {
      "main": [
        [
          {
            "node": "Split Staff List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Staff List": {
      "main": [
        [
          {
            "node": "Has Staff?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Staff?": {
      "main": [
        [
          {
            "node": "Loop Over Staff",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Staff Appointments": {
      "main": [
        [
          {
            "node": "Merge Token + Appointments",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Token + Appointments": {
      "main": [
        [
          {
            "node": "Has Appointments?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Appointments?": {
      "main": [
        [
          {
            "node": "Process Appointments",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop Over Staff",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Appointments": {
      "main": [
        [
          {
            "node": "Create Google Event1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Rescheduled List": {
      "main": [
        [
          {
            "node": "Has Rescheduled?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Update Data": {
      "main": [
        [
          {
            "node": "Should Update?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Update?": {
      "main": [
        [
          {
            "node": "Update Google Event1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Cancelled List": {
      "main": [
        [
          {
            "node": "Has Cancelled?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Delete Data": {
      "main": [
        [
          {
            "node": "Should Delete?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Delete?": {
      "main": [
        [
          {
            "node": "Delete Google Event1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Push Webhook": {
      "main": [
        [
          {
            "node": "Respond Push OK",
            "type": "main",
            "index": 0
          },
          {
            "node": "Parse Push Headers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Push Headers": {
      "main": [
        [
          {
            "node": "Valid Push?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Valid Push?": {
      "main": [
        [
          {
            "node": "Needs Renewal?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Needs Renewal?": {
      "main": [
        [
          {
            "node": "Renew Watch",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Push Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Renew Watch": {
      "main": [
        [
          {
            "node": "Get Push Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Push Token": {
      "main": [
        [
          {
            "node": "Get Google Events1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Staff Token1": {
      "main": [
        [
          {
            "node": "Get Staff Appointments",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Google Event1": {
      "main": [
        [
          {
            "node": "Mark as Synced1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark as Synced1": {
      "main": [
        [
          {
            "node": "Loop Over Staff",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Rescheduled1": {
      "main": [
        [
          {
            "node": "Process Rescheduled List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Rescheduled?1": {
      "main": [
        [
          {
            "node": "Prepare Update Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Google Event1": {
      "main": [
        [
          {
            "node": "Mark as Updated1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Cancelled1": {
      "main": [
        [
          {
            "node": "Process Cancelled List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Cancelled?1": {
      "main": [
        [
          {
            "node": "Prepare Delete Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Google Event1": {
      "main": [
        [
          {
            "node": "Mark as Deleted1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Google Events1": {
      "main": [
        [
          {
            "node": "Process Google Events1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Google Events1": {
      "main": [
        [
          {
            "node": "Cleanup Deleted Events1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Has External Events?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has External Events?1": {
      "main": [
        [
          {
            "node": "Split External Events1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split External Events1": {
      "main": [
        [
          {
            "node": "Block Time Slots1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Staff": {
      "main": [
        [
          {
            "node": "Get Staff Token1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Every Hour (Reminders)": {
      "main": [
        [
          {
            "node": "Get Upcoming Appointments (Reminders)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Upcoming Appointments (Reminders)": {
      "main": [
        [
          {
            "node": "Filter Needing Reminders",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Needing Reminders": {
      "main": [
        [
          {
            "node": "Has Reminders?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Reminders?": {
      "main": [
        [
          {
            "node": "Process Each Reminder",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Reminders",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Each Reminder": {
      "main": [
        [
          {
            "node": "Schedule Reminder Call",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send SMS Reminder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Reminder Call": {
      "main": [
        [
          {
            "node": "Process Each Reminder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send SMS Reminder": {
      "main": [
        [
          {
            "node": "Process Each Reminder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Email Webhook": {
      "main": [
        [
          {
            "node": "Validate Email Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Email Data": {
      "main": [
        [
          {
            "node": "Prepare Email Content",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Email Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Email Content": {
      "main": [
        [
          {
            "node": "Send via SMTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send via SMTP": {
      "main": [
        [
          {
            "node": "Log Email to Database",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Email to Database": {
      "main": [
        [
          {
            "node": "Respond Email Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini for Memory Analysis": {
      "ai_languageModel": [
        [
          {
            "node": "Analyze with Gemini",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parse Webhook Data1": {
      "main": [
        [
          {
            "node": "Has Valid Data?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Valid Data?1": {
      "main": [
        [
          {
            "node": "Analyze with Gemini",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Validation Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Ended Webhook": {
      "main": [
        [
          {
            "node": "Parse Webhook Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Gemini Response": {
      "main": [
        [
          {
            "node": "Analysis Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analysis Valid?": {
      "main": [
        [
          {
            "node": "Prepare Memories",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prepare Preferences",
            "type": "main",
            "index": 0
          },
          {
            "node": "Update Customer Summary",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Analysis Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Memories": {
      "main": [
        [
          {
            "node": "Save Memories",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Memories": {
      "main": [
        [
          {
            "node": "Respond Memory Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Preferences": {
      "main": [
        [
          {
            "node": "Save Preferences",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze with Gemini": {
      "main": [
        [
          {
            "node": "Parse Gemini Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": true,
    "saveExecutionProgress": true,
    "errorWorkflow": "ZkQplwjtccGdKYZd"
  },
  "versionId": "c2b3f942-0cca-48e2-b0da-a15fe4a2b6d6",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "6bffb0e0b31b4d744a3d67a5188397c17f15bfefa2e284777375c509005eb35b"
  },
  "id": "ZkQplwjtccGdKYZd",
  "tags": [
    {
      "updatedAt": "2025-12-18T11:38:28.569Z",
      "createdAt": "2025-12-18T11:38:28.569Z",
      "id": "bdKkVWQtJxMCbe3h",
      "name": "AI Agent"
    },
    {
      "updatedAt": "2025-12-18T11:38:28.653Z",
      "createdAt": "2025-12-18T11:38:28.653Z",
      "id": "wRObD0zfKZT3ZUuR",
      "name": "Calendar"
    },
    {
      "updatedAt": "2025-12-18T11:38:28.656Z",
      "createdAt": "2025-12-18T11:38:28.656Z",
      "id": "XkRe8BEHggbfwdmF",
      "name": "Reminders"
    },
    {
      "updatedAt": "2025-12-18T11:38:28.671Z",
      "createdAt": "2025-12-18T11:38:28.671Z",
      "id": "cKRTTwp0PvGVoC3i",
      "name": "Messaging"
    },
    {
      "updatedAt": "2025-12-18T11:38:28.672Z",
      "createdAt": "2025-12-18T11:38:28.672Z",
      "id": "yRsCORpwIx2LNm3T",
      "name": "Memory"
    }
  ]
}